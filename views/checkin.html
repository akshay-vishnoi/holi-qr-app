<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Check-in Scanner</title>
  <style>
    body{font-family:system-ui,Arial;margin:16px;max-width:820px}
    #reader{width:100%;max-width:420px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
    .status{font-weight:800}
    button{padding:10px 14px;font-weight:700;margin-right:8px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .links a{margin-right:12px}
    #fullOverlay.good { background: #0b7a2a; color: white; }
    #fullOverlay.bad  { background: #b00020; color: white; }
    #fullOverlay.warn { background: #b36b00; color: white; }
  </style>
</head>
<body>
  <h1>Event Check-in</h1>
  <div class="box" id="statsBox" style="margin-top:10px;">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <b>Checked-in:</b> <span id="checkedInCount">-</span>
      <b>Total regs:</b> <span id="totalRegs">-</span>
      <b>Capacity:</b> <span id="capLimit">-</span>
      <span id="lockState" class="status"></span>
      <button id="fullscreenBtn" style="margin-left:auto;">Fullscreen Mode</button>
    </div>
  </div>

  <div id="fullOverlay" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;text-align:center;padding:24px;">
    <div>
      <div id="overlayTitle" style="font-size:64px;font-weight:900;line-height:1;"></div>
      <div id="overlayMsg" style="font-size:28px;margin-top:16px;"></div>
      <div id="overlaySub" style="font-size:18px;margin-top:10px;opacity:0.9;"></div>
    </div>
  </div>

  <div class="links">
    <a href="/admin/dashboard">Admin dashboard</a>
    <a href="/admin/logout">Logout</a>
  </div>

  <div class="row">
    <div>
      <div id="reader"></div>
      <div style="margin-top:10px;">
        <button id="startBtn">Start Camera</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
    </div>

    <div class="box" style="flex:1;min-width:260px">
      <div class="status" id="status">Ready</div>
      <div id="message"></div>
      <pre id="details" style="white-space:pre-wrap;"></pre>

      <hr />
      <p><b>Manual fallback:</b></p>
      <input id="manual" style="width:100%;padding:10px" placeholder="Paste QR text here" />
      <button id="manualBtn" style="margin-top:8px;">Check-in</button>
    </div>
  </div>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const statusEl = document.getElementById("status");
    const messageEl = document.getElementById("message");
    const detailsEl = document.getElementById("details");

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const manualInput = document.getElementById("manual");
    const manualBtn = document.getElementById("manualBtn");

    let scanner = null;
    let lastQr = null;
    let busy = false;

    const checkedEl = document.getElementById("checkedInCount");
    const totalEl = document.getElementById("totalRegs");
    const capEl = document.getElementById("capLimit");
    const lockEl = document.getElementById("lockState");
    const fsBtn = document.getElementById("fullscreenBtn");

    const overlay = document.getElementById("fullOverlay");
    const overlayTitle = document.getElementById("overlayTitle");
    const overlayMsg = document.getElementById("overlayMsg");
    const overlaySub = document.getElementById("overlaySub");

    async function refreshStats() {
      try {
        const res = await fetch("/api/stats");
        const data = await res.json();
        if (!data.ok) return;

        checkedEl.textContent = data.checkedIn;
        totalEl.textContent = data.totalRegs;
        capEl.textContent = data.capacityLimit;
        lockEl.textContent = data.locked ? "LOCKED" : "OPEN";
      } catch {}
    }

    function showOverlay(type, title, msg, sub) {
      overlay.className = "";
      overlay.classList.add(type);
      overlayTitle.textContent = title;
      overlayMsg.textContent = msg || "";
      overlaySub.textContent = sub || "";
      overlay.style.display = "flex";
      setTimeout(() => (overlay.style.display = "none"), 1400);
    }

    fsBtn.addEventListener("click", async () => {
      if (!document.fullscreenElement) {
        await document.documentElement.requestFullscreen();
        fsBtn.textContent = "Exit Fullscreen";
      } else {
        await document.exitFullscreen();
        fsBtn.textContent = "Fullscreen Mode";
      }
    });


    function setUI(status, message, details) {
      statusEl.textContent = status;
      messageEl.textContent = message || "";
      detailsEl.textContent = details ? JSON.stringify(details, null, 2) : "";
    }

    async function checkin(qrText) {
      if (!qrText) return;
      if (busy) return;
      if (qrText === lastQr) return; // prevent double firing on same code
      busy = true;
      lastQr = qrText;

      setUI("Checking…", "", null);

      try {
        const res = await fetch("/api/checkin", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ qrText })
        });
        const data = await res.json();

        if (!data.ok) {
          setUI("❌ Invalid", data.message, data);
          showOverlay("bad", "INVALID", data.message);
        } else if (data.status === "locked") {
          setUI("⛔ LOCKED", data.message, data.stats);
          showOverlay("bad", "LOCKED", data.message, `Checked-in: ${data.stats.checkedIn} / Limit: ${data.stats.capacityLimit}`);
        } else if (data.status === "already") {
          setUI("⚠️ Already Checked-in", data.message, data.registration);
          showOverlay("warn", "ALREADY", data.message, `ID ${data.registration.id}`);
        } else {
          setUI("✅ Checked-in", data.message, data.registration);
          showOverlay("good", "CHECKED IN", data.message, `ID ${data.registration.id}`);
        }
        await refreshStats();
      } catch (e) {
        setUI("❌ Error", "Network/server error", { error: String(e) });
      } finally {
        busy = false;
        setTimeout(() => { lastQr = null; }, 2000);
      }
    }

    async function start() {
      if (!scanner) scanner = new Html5Qrcode("reader");

      setUI("Starting camera…", "", null);

      try {
        await scanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 } },
          (decodedText) => checkin(decodedText)
        );
        startBtn.disabled = true;
        stopBtn.disabled = false;
        setUI("Scanning…", "Point camera at QR", null);
      } catch (e) {
        setUI("❌ Camera Error", "Could not access camera. Try HTTPS or allow permission.", { error: String(e) });
      }
    }

    async function stop() {
      if (!scanner) return;
      await scanner.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      setUI("Stopped", "", null);
    }

    startBtn.addEventListener("click", start);
    stopBtn.addEventListener("click", stop);
    manualBtn.addEventListener("click", () => checkin(manualInput.value.trim()));

    // ---- Keep Render service warm (Free plan) ----
    // Pings /health every 2 minutes while this page is open
    setInterval(() => {
      fetch("/health")
        .then(() => console.log("Keep-alive ping sent"))
        .catch(() => console.log("Keep-alive failed"));
    }, 120000); // 120000 ms = 2 minutes
  
    refreshStats();
    setInterval(refreshStats, 5000); // update counts every 5s
  </script>
</body>
</html>
